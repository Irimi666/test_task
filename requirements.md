# Описание системы:

Онлайн-маркетплейс товаров. Необходимо реализовать отправку пуш-уведомлений в мобильное приложение об изменении статуса заказа. Данные об изменении статуса получать из API внешнего сервиса.

### Ключевые требования системы:

1. Получение статуса заказа из API внешнего сервиса.
2. Формирование контента уведомления в соответствии с полученными данными.
3. Отправка push-уведомления.
4. Фиксация результатов в БД. 

### Границы требований процесса:

* **Начало**: получение данных об изменении статуса заказа из API внешнего сервиса.

* **Конец**: фиксация финального статуса уведомления (`DELIVERED`, `CANCELLED` или `FAILED`).

* **Участники**:

    * внешний сервис доставки;

    * система маркетплейса;

    * мобильное приложение пользователя.



## Функциональные требования

Функциональные требования описывают основные функции системы, необходимые для реализации push-уведомлений в мобильное приложение об изменении статуса заказа

1. Получение данных о статусе заказа
2. Анализ изменений статуса
3. Формирование контента уведомления
4. Отправка push-уведомления
5. Обработка результатов отправки
6. Управление статусами уведомлений

<details> <summary>Подробности</summary>

1. **Получение данных о статусе заказа из внешнего API**

    * Автоматический опрос API внешнего сервиса доставки с настраиваемым интервалом (<mark>не даны точные сведения о сервисе и его ограничениях</mark>)

    * Запрос статуса по конкретному заказу через эндпоинт: `GET /orders/status/{order_id}`

    * Обработка JSON‑ответов с обязательными полями:

        * `order_id` — идентификатор заказа

        * `status` — текущий статус заказа

        * `timestamp` — время изменения статуса

        * `details` — дополнительные детали (перевозчик, трек‑номер и т.д.)
        * Обработка ошибок API (4xx, 5xx) с последующим завершением процесса

2. **Анализ изменений статуса**
   
    * Сравнение нового статуса с предыдущим (хранится в БД маркетплейса)

    * Фиксация факта изменения статуса для инициирования отправки уведомления

    * Проверка актуальности заказа (не отменён, не завершён)

3. **Формирование контента уведомления**
    
    * Подбор шаблона текста под конкретный статус заказа

    * Подстановка динамических данных в шаблон (например):

        * номер заказа

        * текущий статус

        * детали доставки из поля details

        * расчётное время доставки

    * Генерация deep link для перехода в раздел заказа в мобильном приложении

    * Формирование payload для push‑сервисов (FCM/APNs) со структурой:
    ```json
    {
    "title": "Заказ в пути",
    "body": "Ваш заказ № ORD-12345 передан курьеру",
    "deep_link": "app://orders/ORD-12345"
    }
    ```

4. **Отправка push‑уведомлений**
    
    * Интеграция с внешними push‑сервисами:

        * FCM (Firebase Cloud Messaging) для Android

        * APNs (Apple Push Notification Service) для iOS

5. **Обработка результатов отправки**

    * Проверка HTTP‑статуса от push‑сервиса:

        * 200/201 — успех (DELIVERED)

        * 4xx/5xx — ошибка

    * Логирование результатов отправки:

        * успех: фиксация `delivered_at`;

        * ошибка: запись `error_code`

    
6. **Управление статусами уведомлений**

    * Поддержка статусов:

        `CREATED` — уведомление создано, отправка не начата

        `SENDING` — идёт отправка в push‑сервис

        `DELIVERED` — push‑сервис подтвердил приём

        `FAILED` — попытка отправки завершилась ошибкой

        `CANCELLED` — отправка отменена до начала

    * Автоматическое обновление статусов на каждом этапе процесса

</details>   

## Нефункциональные требования 

Основные требования системы определяют характеристики системы, такие как производительность и время отклика

1. Производительность
2. Надежность
3. Отказоустойчивость
4. Логирование

<details> 

<summary>Подробности</summary>

1. **Производительность**

    * время обработки одного уведомления ≤ N секунд

    * пиковая нагрузка: до N уведомлений в минуту

    * задержка доставки ≤ N минут / секунд

2. **Надежность**
    
    * доступность сервиса: N дней в месяц / N% времени

    * устойчивость к сбоям внешнего API

3. **Отказоустойчивость**

    * автоматическое восстановление после сбоев

    * резервное копирование логов и данных о статусах

4. **Безопасность**

    * шифрование данных при передаче (HTTPS)

    * защита токенов устройств (не хранить в открытом виде)

    * аутентификация запросов к API внешнего сервиса

5. **Логирование**

    * запись всех этапов процесса в лог (`timestamp`, `order_id`, `status`, `result`, `error_code`)

    * хранение логов N времени

    * доступ к данным о статусах заказов 

</details>


## UML диаграмма состояния

